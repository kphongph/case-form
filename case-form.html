<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../core-selector/core-selector.html">
<link rel="import" href="../core-toolbar/core-toolbar.html">

<link rel="import" href="questions/case-question-single-select.html">
<link rel="import" href="form-datasource.html">

<polymer-element name="case-form" attributes="src filled" layout vertical>

  <template>
    <link rel="stylesheet" href="case-form.css">
    <form-datasource url="{{src}}" form="{{form}}"></form-datasource>
    
    <div id="questionPanel" class="question-panel" vertical flex>
      <div class="card {{ {answered: answered} | tokenList }}" 
        flex layout vertical hero-p>

        <core-toolbar class="theme-bg" cross-fade-delayed hero>
          <div flex>{{question.question}}</div>
        </core-toolbar>

        <div hidden?="{{!form}}" flex> 
          <core-selector id="questionViews" 
            on-question-answered="{{questionAnswered}}"
            cross-fade-delayed hero
            notap selected="{{question.type}}">
            <case-question-single-select name="single-select">
            </case-question-single-select>
          </core-selector>
        </div>
        <paper-fab class="check-button" icon="check" 
           on-tap="{{questionDone}}"></paper-fab>
      </div>

   </div>
    
  </template>

  <script>
    Polymer('case-form',{
      answered:false,
      icon:"check",
      observe: { 
        'form':'update'
      },
      ready: function() {
      },
      update: function() {
        if(this.form) {
          this.index = 0;
        }
      },
      indexChanged: function() {
        if(this.form.questions) { 
          if(this.form.questions.length > this.index) {
            this.question = this.form.questions[this.index];
          } else {
            this.filled = this.form;
          }
        }
      },
      questionChanged: function() {
        if(this.questionView) {
          this.questionView.reset();
        } 

        if(this.question) {
          this.questionView = this.$.questionViews.querySelector(
           '[name="'+this.question.type+'"]');
          if(this.questionView) {
            this.questionView.question = this.question;
          }
        }
      },
      questionAnswered: function() {
        this.answered = true;
      },
      questionDone: function() {
        if(this.question) {
          this.questionView.setAnswer();
        }
        this.next();
      },
      next:function() {
        this.index++;
        this.answered = false;
        if(this.questionView) {
          this.questionView.reset();
        }
      }
    });
  </script>

</polymer-element>
